# 源作者项目地址

https://github.com/Ayaka-Yuki/GPT-SoVITS-fine-tuning

# 官方仓库地址

https://github.com/RVC-Boss/GPT-SoVITS

# 操作手册

本手册为最小可运行流程的使用说明。面向想要快速完成准备数据、提取特征、训练与推理的用户。

## 1. 环境准备

1) 安装依赖
```bash
pip install -r requirements.txt
```
说明：安装项目所需的 Python 包。

2) 放置预训练资源到 `pretrained_models/`
- chinese-roberta-wwm-ext-large/：中文 BERT 目录，包含 config.json、pytorch_model.bin、tokenizer 文件
- chinese-hubert-base/：中文 CN-HuBERT 目录，包含 config.json、pytorch_model.bin、preprocessor_config 文件
- s2G488k.pth、s2D488k.pth：SoVITS 预训练权重
- s1bert25hz-2kh-longer-epoch=68e-step=50232.ckpt: GPT 文件

目录示例：
```
tts/train/pretrained_models/
├─ chinese-roberta-wwm-ext-large/
├─ chinese-hubert-base/
├─ s1bert25hz-2kh-longer-epoch=68e-step=50232.ckpt
├─ s2G488k.pth
└─ s2D488k.pth
```

## 2. 准备数据

1) 准备若干段 3-8 秒的干净人声音频，保存到：
```
tools/denoised/output/sample(*).wav
```
用途：作为训练/特征提取的源音频样本。

2) 创建标注文件：
```
tools/output/final_phonetic_transcriptions.txt
```
内容示例（一行一个样本，用竖线分隔）：
```
tools/denoised/output/sample(1).wav|spk1|zh|大家好，我是测试语音。
tools/denoised/output/sample(2).wav|spk1|ja|おばあちゃんのミラキュラスカーレットライブハウスやってた
```
字段说明：
- 第1列：音频路径（项目内相对路径或绝对路径）
- 第2列：说话人标识（任意字符串）
- 第3列：语言（常用 zh/en/ja/ko/yue）
- 第4列：该音频片段的文本

## 3. 提取特征

3.1 文本侧特征（音素、BERT）
```bash
python 1-dp-get-text.py
```
作用：
- 将文本转为音素序列
- 使用 BERT 提取文本特征
输出：
```
logs/v1_trial/
├─ 2-name2text.txt              # 对齐信息：文件名、音素、word2ph、规范化文本
└─ 3-bert/<wav文件名>.pt        # 与音素对齐的 BERT 特征，目前只支持中文，使用其他语言不会生成
```

3.2 音频侧特征（CN-HuBERT）
```bash
python 2-dp-get-hubert-wav32k.py
```
作用：
- 使用 CN-HuBERT 提取音频的内容特征
- 生成归一化的 32k 音频副本
输出：
```
logs/v1_trial/
├─ 4-cnhubert/<wav文件名>.pt    # HuBERT 特征
└─ 5-wav32k/<wav文件名>         # 归一化后的 32k wav
```

3.3 语义标记（Semantic Tokens）
```bash
python 3-dp-get-semantic.py
```
作用：将 HuBERT 特征离散化为语义标记。
输出：
```
logs/v1_trial/6-name2semantic.tsv
```

## 4. 训练

4.1 训练 SoVITS（从语义标记到音频）
```bash
python s2_train.py --config "./configs/tmp_s2.json" --exp_dir "./logs/v1_trial"
```

**配置文件解读**（tmp_s2.json）：
```json
{
  "train": {
    "epochs": 20,           # 训练 20 轮
    "batch_size": 4,        # 每次喂 4 个样本
    "learning_rate": 0.0001 # 学习速度
  },
  "model": {
    "hidden_channels": 192,  # 模型复杂度
    "n_layers": 6           # 模型层数
  }
}
```

参数说明：
- --config：训练配置文件路径（json）
- --exp_dir：实验目录，影响日志与中间结果输出位置（如 logs/v1_trial）

输出位置：
- 检查点：`logs/v1_trial/logs_s2/`，文件名形如 `G_<step>.pth`、`D_<step>.pth`
- 导出权重（若开启保存）：`SoVITS_weights/`，文件名形如 `v1_trial_e{epoch}_s{step}.pth`

4.2 训练 GPT（从文本到语义标记）
```bash
python s1_train.py --config "configs/tmp_s1.yaml"
```

**配置文件解读**（tmp_s1.yaml）：
```yaml
model:
  n_layer: 24              # Transformer 层数
  hidden_dim: 512          # 隐藏层维度
  head: 16                 # 注意力头数

optimizer:
  lr: 0.01                 # 学习率
  warmup_steps: 2000       # 预热步数

train:
  epochs: 40               # 训练轮数
  batch_size: 4
```

参数说明：
- --config：训练配置文件路径（yaml）

输出位置：
- `GPT_weights/`，文件名通常包含 `e{epoch}`（例如 `v1_trial-e40.ckpt`）

## 5. 推理

命令示例：
```bash
python inference_cli.py \
  --gpt_model ./GPT_weights/v1_trial-e40.ckpt \
  --sovits_model ./SoVITS_weights/v1_trial_e20_s480.pth \
  --target_text ./test_text/text.txt \
  --output_path ./inference_output
  --lang ja

# 快捷复制 python inference_cli.py --gpt_model ./GPT_weights/v1_trial-e40.ckpt  --sovits_model ./SoVITS_weights/v1_trial_e20_s480.pth  --target_text ./test_text/text.txt --output_path ./inference_output --lang ja       
```
参数说明：
- --gpt_model：GPT 权重文件路径（.ckpt）
- --sovits_model：SoVITS 权重文件路径（.pth）
- --target_text：待合成文本文件路径（txt，自动探测编码）
- --output_path：输出目录，生成的 wav 文件保存在此目录下
- --lang：选择语言，auto|zh|en|ja|ko|yue (default: auto)

重要说明：
- `inference_cli.py` 内部使用 `tools/denoised/output/reference.wav` 作为参考音频路径。如需替换，请编辑该脚本对应行，将其改为你自己的参考音频路径（3-5 秒）。参考音频用于指定音色。

- 目前暂未支持其他语言的BERT，推理其他语言时并未使用BERT

## 6. 常见问题

1) ffmpeg 缺失导致“音频加载失败”
- 现象：WinError 2 或 RuntimeError: 音频加载失败
- 处理：安装 ffmpeg 并加入 PATH；重开终端后重试。

2) LangSegment 导入错误
- 现象：ImportError: cannot import name 'setLangfilters'
- 处理：项目已加入兼容导入与回退；确保 `pip install LangSegment` 或使用降级回退继续推理。

3) G2PW 模型下载失败（404）
- 现象：Error initializing G2PWPinyin: 404
- 处理：已加入 pypinyin 回退，无需中断推理；如需 G2PW，请自行下载模型到 `tools/G2PWModel/`。

4) Windows 上分布式（libuv）报错
- 现象：use_libuv was requested but PyTorch was build without libuv support
- 处理：`s2_train.py` 已默认在 Windows/单卡走单进程；如需 DDP，多卡并在非 Windows 环境设置 `S2_DDP=1`。


